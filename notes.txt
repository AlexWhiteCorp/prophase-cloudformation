- name: Deploy Amazon EKS Cluster
  id: eks-cluster
  uses: aws-actions/aws-cloudformation-github-deploy@master
  with:
    name: ${{ steps.env-name.outputs.environment }}-cluster
    template: https://s3.amazonaws.com/aws-quickstart/quickstart-amazon-eks/templates/amazon-eks-master.template.yaml
    no-fail-on-empty-changeset: "1"
    parameter-overrides: >-
      AvailabilityZones=${{ github.event.inputs.region }}a,
      AvailabilityZones=${{ github.event.inputs.region }}c,
      KeyPairName=${{ github.event.inputs.keypair }},
      NumberOfAZs=2,
      ProvisionBastionHost=Disabled,
      EKSPublicAccessEndpoint=Enabled,
      EKSPrivateAccessEndpoint=Enabled,
      RemoteAccessCIDR=0.0.0.0/0

  DDAgentServiceECS:
    Type: AWS::ECS::Service
    Properties:
      LaunchType: FARGATE
      Cluster:
        Ref: "ECSCluster"
      DesiredCount: 1
      TaskDefinition:
        Ref: DDAgentServiceDefinition
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
            - !GetAtt ALB2FargateContainersSG.GroupId
          Subnets:
            - subnet-08e523a5d8cfc4bad
            - subnet-04a6f0c79e66d298b
            - subnet-06c9b90d113095ae2
      LoadBalancers:
        - TargetGroupArn:
            Ref: FargateTargetGroup
          ContainerPort: 8126
          ContainerName: dd-agent-service-task